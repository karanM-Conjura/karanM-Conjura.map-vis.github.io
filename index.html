<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Geograph Revenue Insight</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <h1> Total Revenue generated per country</h1>
    <div id="map"></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2FyYW4tYzAiLCJhIjoiY2xxNmd1ZGdrMHIwMTJrcGFkYWxzbWE2NyJ9.W1usXxcSztAC5kqG-GqQOw';
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            center: [-6.33, 53.33], // starting position [lng, lat]
            style: 'mapbox://styles/mapbox/dark-v11', //'mapbox://styles/mapbox/light-v11'
            zoom: 10, // starting zoom
            projection: 'mercator'
        });

        // // Create Conjura marker
        // const conjura = new mapboxgl.Marker({
        //     scale: 0.6
        // })
        // map.on('load', () => {
        //     // Load  image from URL.
        //     map.loadImage(
        //         'https://raw.githubusercontent.com/karanM-Conjura/map-vis/main/conjura_owl.jpeg.png',
        //         (error, image) => {
        //             if (error) throw error;

        //             map.addImage('owl', image);

        //             map.addSource('point', {
        //                 'type': 'geojson',
        //                 'data': {
        //                     'type': 'FeatureCollection',
        //                     'features': [
        //                         {
        //                             'type': 'Feature',
        //                             'geometry': {
        //                                 'type': 'Point',
        //                                 'coordinates': [-6.33, 53.33]
        //                             }
        //                         }
        //                     ]
        //                 }
        //             });

        //             map.addLayer({
        //                 'id': 'points',
        //                 'type': 'symbol',
        //                 'source': 'point', // data source
        //                 'layout': {
        //                     'icon-image': 'owl', // image reference
        //                     'icon-size': 0.25
        //                 }
        //             });
        //         }
        //     );
        // });

        

        map.on('load', () => {
        // add source
        map.addSource('revenues', {
            type: 'geojson',
            data: {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "United Kingdom",
                            "revenue": 8391410.04
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-2.2426, 54.6197]  
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Australia",
                            "revenue": 75396.62
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [133.7751, -25.2744]  
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "United States",
                            "revenue": 45479.73
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-95.7129, 37.0902] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Germany",
                            "revenue": 32321.91
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [9.9937, 51.1657] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "New Zealand",
                            "revenue": 20175.72
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [173.9475, -40.9006] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "France",
                            "revenue": 18448.86
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [1.583748,47.046265] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Gambia",
                            "revenue": 12653.5
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-15.466111,13.498309] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Saudi Arabia",
                            "revenue": 8598.41
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [43.425865,23.728155] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Israel",
                            "revenue": 6309.74
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [34.954119,31.688773] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Canada",
                            "revenue": 6264.74
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-106.415462,55.573201] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Sweden",
                            "revenue": 5785
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [18.117142,64.957061] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Malta",
                            "revenue": 5641.2
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [14.438503,35.883087] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Bulgaria",
                            "revenue": 5399.9
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [24.919052,42.865270] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Italy",
                            "revenue": 4960.34
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [13.036480,42.461587] 
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "name": "Spain",
                            "revenue": 4259.9
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-4.037991,41.106390] 
                        }
                    }
                ]
            },
            cluster: true,
            clusterMaxZoom: 14, // Max zoom to cluster points on
            clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
        });

        map.addLayer({
            id: 'clusters',
            type: 'circle',
            source: 'revenues',
            filter: ['has', 'point_count'],
            paint: {
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#51bbd6',
                    100,
                    '#f1f075',
                    750,
                    '#f28cb1'
                ],
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    20,
                    100,
                    30,
                    750,
                    40
                ]
            }
        });

        map.addLayer({
            id: 'cluster-count',
            type: 'symbol',
            source: 'revenues',
            filter: ['has', 'point_count'],
            layout: {
                'text-field': ['get', 'point_count_abbreviated'],
                'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                'text-size': 12
            }
        });

        map.addLayer({
            id: 'unclustered-point',
            type: 'circle',
            source: 'revenues',
            filter: ['!', ['has', 'point_count']],
            paint: {
                'circle-color': '#11b4da',
                'circle-radius': 4,
                'circle-stroke-width': 1,
                'circle-stroke-color': '#fff'
            }
        });

        // inspect a cluster on click
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('revenues').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;

                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        map.on('click', 'unclustered-point', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const revenue = e.features[0].properties.revenue;

            
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(`Revenue: £${revenue.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`)
                .addTo(map);
        });

        // Add markers and popups
        const markers = [
            {
                name: 'United Kingdom',
                coordinates: [-1.348228, 52.617432],
                popupText: 'UK: A new record has been set for revenue generated from this country!'
            },
            {
                name: 'Australia',
                coordinates: [137.846489, -27.695992],
                popupText: 'Australia: Second highest grossing revenue!'
            },
            {
                name: 'United States',
                coordinates: [-95.450249, 36.319828],
                popupText: 'United States: Down by 45% compared to last year...'
            },
            {
                name: 'Germany',
                coordinates: [9.942112, 51.400223],
                popupText: 'Germany: Up by 5% from last year. Marketing Spend should be focused here.'
            },
            {
                name: 'New Zealand',
                coordinates: [173.9475, -40.9006],
                popupText: 'New Zealand: 35% increase from last year. Continue investing in this region.'
            }
        ];

        markers.forEach((marker) => {
            const popup = new mapboxgl.Popup({ offset: 25 }).setText(marker.popupText);

            new mapboxgl.Marker({
                color: '#440154',
                scale: 1
            })
                .setLngLat(marker.coordinates)
                .setPopup(popup)
                .addTo(map);
        });

        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });
    });
</script>
</body>
</html>
